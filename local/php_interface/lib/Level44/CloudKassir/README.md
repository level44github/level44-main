# Интеграция с CloudKassir API

Модуль для автоматического формирования чеков в CloudKassir при поступлении оплаты заказа.

## Особенности

- ✅ Полное взаимодействие с CloudKassir через API (без использования модуля)
- ✅ Автоматическое формирование чеков при оплате заказа
- ✅ Учет только реально оплаченной суммы (без бонусов)
- ✅ Поддержка товаров и доставки
- ✅ Настройка НДС, системы налогообложения и других параметров

## Настройка

Для работы модуля необходимо настроить следующие параметры через `\Bitrix\Main\Config\Option`:

### Обязательные параметры:

1. **`level44.cloudkassir.enabled`** - Включить/выключить модуль (`Y`/`N`)
2. **`level44.cloudkassir.public_id`** - Public ID из личного кабинета CloudPayments
3. **`level44.cloudkassir.api_secret`** - API Secret из личного кабинета CloudPayments
4. **`level44.cloudkassir.inn`** - ИНН организации

### Опциональные параметры:

- **`level44.cloudkassir.api_url`** - URL API (по умолчанию: `https://api.cloudpayments.ru/kkt/receipt`)
- **`level44.cloudkassir.vat_rate`** - Ставка НДС по умолчанию для товаров (0, 10, 20 или null)
- **`level44.cloudkassir.delivery_vat_rate`** - Ставка НДС для доставки по умолчанию (0, 5, 10, 20 или null). По умолчанию: 5. Приоритет имеет ставка из настроек конкретной доставки в платежной системе.
- **`level44.cloudkassir.payment_object`** - Предмет расчета (по умолчанию: 1 - товар)
- **`level44.cloudkassir.payment_method`** - Способ расчета (по умолчанию: 1 - предоплата 100%)
- **`level44.cloudkassir.taxation_system`** - Система налогообложения (по умолчанию: 1 - УСН доход)
- **`level44.cloudkassir.allowed_payment_systems`** - Список ID разрешенных платежных систем для печати чеков (через запятую, по умолчанию: `14,17`). Если пусто, чеки печатаются для всех платежных систем.
- **`level44.cloudkassir.bonus_payment_system_id`** - ID платежной системы для бонусных платежей (по умолчанию: `18`). Используется для исключения бонусных платежей из чека и пропорционального уменьшения сумм товаров.

## Пример настройки

```php
use Bitrix\Main\Config\Option;

// Включить модуль
Option::set('level44.cloudkassir', 'enabled', 'Y');

// Учетные данные
Option::set('level44.cloudkassir', 'public_id', 'pk_xxxxxxxxxxxxx');
Option::set('level44.cloudkassir', 'api_secret', 'xxxxxxxxxxxxxxxxxxxxx');

// ИНН организации
Option::set('level44.cloudkassir', 'inn', '1234567890');

// Настройки НДС
Option::set('level44.cloudkassir', 'vat_rate', '20');
Option::set('level44.cloudkassir', 'delivery_vat_rate', '5'); // По умолчанию 5%, но приоритет имеет настройка из платежной системы

// Система налогообложения
Option::set('level44.cloudkassir', 'taxation_system', '1'); // 1 - УСН доход, 0 - ОСН, 2 - УСН доход-расход

// Разрешенные платежные системы для печати чеков
Option::set('level44.cloudkassir', 'allowed_payment_systems', '14,17'); // Только для платежных систем с ID 14 и 17

// ID бонусной платежной системы
Option::set('level44.cloudkassir', 'bonus_payment_system_id', '18'); // ID платежной системы для бонусов
```

## Как это работает

1. При оплате заказа срабатывает событие `OnSaleOrderPaid`
2. Обработчик `CloudKassirHandlers::OnSaleOrderPaidHandler` получает заказ
3. Вычисляется реально оплаченная сумма (без учета бонусных платежей)
4. Формируется запрос к API CloudKassir с данными чека
5. Чек отправляется клиенту на email/телефон

## Важно

- В чеки попадает **только реально оплаченная сумма** (без бонусов)
- Бонусные платежи (платежи с ID, указанным в `bonus_payment_system_id`, по умолчанию 18) автоматически исключаются
- Если в заказе есть бонусная оплата, сумма бонусов пропорционально вычитается из всех товаров в чеке (кроме доставки)
- Если заказ оплачен только бонусами, чек не формируется
- Чеки формируются **только для разрешенных платежных систем** (по умолчанию: 14, 17)
- При переводе заказа в статус "Возврат" автоматически формируется чек возврата

## Логирование

Все операции логируются в файл `/upload/cloudkassir.log`

## Структура файлов

- `Api.php` - Класс для работы с API CloudKassir
- `CloudKassirHandlers.php` - Обработчики событий Bitrix

