# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OSMI Card (–û–ë–ù–û–í–õ–ï–ù–û)

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

–≠—Ç–∞ –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ API –º–µ—Ç–æ–¥—ã OSMI Card —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–∞–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ (pass) –≤ —Å–∏—Å—Ç–µ–º–µ OSMI Card —á–µ—Ä–µ–∑ endpoint `POST /v2t/passes`.

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### ‚ùå –°—Ç–∞—Ä—ã–µ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ) –º–µ—Ç–æ–¥—ã:
- `/cards/register` - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `/cards/find` - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç  
- `/cards/{id}/balance` - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `/cards/{id}/bonuses/add` - –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### ‚úÖ –ù–æ–≤—ã–µ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ) –º–µ—Ç–æ–¥—ã:
- `POST /passes` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã (pass)
- `GET /passes` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ä—Ç
- `GET /passes/{id}` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ ID
- `PUT /passes/{id}` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- `DELETE /passes/{id}` - —É–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- `POST /passes/{id}/push` - –æ—Ç–ø—Ä–∞–≤–∫–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `GET /templates` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ–ª–µ–π

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å Bitrix:
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **OSMI Card**
- –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è"**

–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø–æ–ª—è:
- `UF_OSMI_CARD_NUMBER` - serial_number –∫–∞—Ä—Ç—ã
- `UF_OSMI_CARD_ID` - ID –∫–∞—Ä—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ OSMI

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

–í —Ä–∞–∑–¥–µ–ª–µ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **OSMI Card** –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- ‚úÖ **–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é** - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥–∞–ª–æ—á–∫—É
- ‚úÖ **API –∫–ª—é—á** - –ø–æ–ª—É—á–∏—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ OSMI Card
- ‚úÖ **Template ID** - ID —à–∞–±–ª–æ–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- **URL API** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `https://api.osmicards.com/v2t`
- **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á** - –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- **ID –ø—Ä–æ–µ–∫—Ç–∞** - –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ Template ID

1. –£–∫–∞–∂–∏—Ç–µ API –∫–ª—é—á
2. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤"**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –Ω—É–∂–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ **"ID —à–∞–±–ª–æ–Ω–∞"**
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞–∂–º–∏—Ç–µ **"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã

–ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `OnAfterUserRegister`
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å `POST /passes` —Å –¥–∞–Ω–Ω—ã–º–∏:
   ```json
   {
     "template_id": "–≤–∞—à_template_id",
     "serial_number": "ID_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
     "barcode": {
       "message": "ID_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
       "format": "QR"
     },
     "fields": {
       "phone": "79001234567",
       "email": "user@example.com",
       "first_name": "–ò–≤–∞–Ω",
       "last_name": "–ò–≤–∞–Ω–æ–≤",
       "middle_name": "–ò–≤–∞–Ω–æ–≤–∏—á"
     }
   }
   ```
3. Serial number (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `UF_OSMI_CARD_NUMBER`
4. ID –∫–∞—Ä—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `UF_OSMI_CARD_ID`

### –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```php
use Level44\Event\OsmiCardHandlers;

$userId = 123;
$serialNumber = OsmiCardHandlers::getUserCardNumber($userId);

if ($serialNumber) {
    echo "Serial number –∫–∞—Ä—Ç—ã: " . $serialNumber;
}
```

### –†–∞–±–æ—Ç–∞ —Å API –Ω–∞–ø—Ä—è–º—É—é

```php
use Level44\OsmiCard\Api;

$api = new Api();

// –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç—É (pass)
$result = $api->registerCard([
    'userId' => 123,
    'phone' => '79001234567',
    'email' => 'user@example.com',
    'firstName' => '–ò–≤–∞–Ω',
    'lastName' => '–ò–≤–∞–Ω–æ–≤',
]);

if ($result['success']) {
    echo "Pass —Å–æ–∑–¥–∞–Ω: " . $result['data']['serial_number'];
    echo "URL –∫–∞—Ä—Ç—ã: " . $result['data']['pass_url'];
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç (passes)
$result = $api->getPasses(['limit' => 10]);

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞—Ä—Ç—É –ø–æ ID
$result = $api->getPass('pass_id_123');

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É
$result = $api->updatePass('pass_id_123', [
    'fields' => [
        'balance' => 100
    ]
]);

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
$result = $api->sendPushNotification('pass_id_123', '–í–∞—à –±–∞–ª–∞–Ω—Å: 100 –±–æ–Ω—É—Å–æ–≤');

// –£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É
$result = $api->deletePass('pass_id_123');

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
$result = $api->getTemplates();
if ($result['success']) {
    foreach ($result['data'] as $template) {
        echo "ID: {$template['id']}, –ù–∞–∑–≤–∞–Ω–∏–µ: {$template['name']}\n";
    }
}
```

## API –º–µ—Ç–æ–¥—ã

### `registerCard(array $userData): array`

–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `POST /passes`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `userId` (int) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ serial_number)
- `phone` (string) - —Ç–µ–ª–µ—Ñ–æ–Ω
- `email` (string) - email
- `firstName` (string) - –∏–º—è
- `lastName` (string) - —Ñ–∞–º–∏–ª–∏—è
- `secondName` (string) - –æ—Ç—á–µ—Å—Ç–≤–æ

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```php
[
    'success' => true,
    'data' => [
        'id' => 'pass_id',
        'serial_number' => '123',
        'pass_url' => 'https://...',
        'full_response' => [...]
    ]
]
```

### `getPass(string $passId): array`

–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø–æ ID —á–µ—Ä–µ–∑ `GET /passes/{id}`.

### `getPasses(array $filters = []): array`

–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞—Ä—Ç —á–µ—Ä–µ–∑ `GET /passes`.

–§–∏–ª—å—Ç—Ä—ã: `serial_number`, `template_id`, `limit`, –∏ —Ç.–¥.

### `updatePass(string $passId, array $data): array`

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `PUT /passes/{id}`.

### `deletePass(string $passId): array`

–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ `DELETE /passes/{id}`.

### `sendPushNotification(string $passId, string $message): array`

–û—Ç–ø—Ä–∞–≤–∫–∞ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ `POST /passes/{id}/push`.

### `getTemplates(): array`

–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ —á–µ—Ä–µ–∑ `GET /templates`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ API

### –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:
```php
[
    'success' => true,
    'data' => [/* –¥–∞–Ω–Ω—ã–µ */]
]
```

### –û—à–∏–±–∫–∞:
```php
[
    'success' => false,
    'error' => '–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏',
    'code' => 400
]
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `/upload/osmi_card.log`:

```
[2025-10-09 12:34:56] –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: 123, serial_number: 123, URL: https://...
[2025-10-09 12:35:01] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: 124. –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω template_id
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ `/upload/osmi_card.log`
3. –í –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–µ **"–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã OSMI"** —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º = ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–•—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–ø—Ü–∏—è—Ö –º–æ–¥—É–ª—è `level44.osmicard`:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
|----------|----------|-------------|
| enabled | –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Y/N) | –î–∞ |
| api_url | URL API | –ù–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://api.osmicards.com/v2t) |
| api_key | API –∫–ª—é—á | –î–∞ |
| secret_key | –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á | –ù–µ—Ç |
| project_id | ID –ø—Ä–æ–µ–∫—Ç–∞ | –ù–µ—Ç |
| **template_id** | **ID —à–∞–±–ª–æ–Ω–∞** | **–î–∞** |

## –û—Ç–ª–∏—á–∏—è –æ—Ç —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏

| –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è | –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è |
|---------------|--------------|
| `/cards/register` | `POST /passes` |
| `cardNumber` | `serial_number` |
| `project_id` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω | `template_id` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω |
| API v1 | API v2t |

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **API OSMI Card**: https://apidocs.osmicards.com/
- **Postman Collection**: https://www.postman.com/osmicards/

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
2. ‚úÖ –£–∫–∞–∑–∞–Ω –ª–∏ Template ID
3. ‚úÖ –í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
4. ‚úÖ –°–æ–∑–¥–∞–ª–∏—Å—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è
5. üìù –ù–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–µ `/upload/osmi_card.log`

---

**–í–µ—Ä—Å–∏—è**: 1.1.0 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)  
**–î–∞—Ç–∞**: 2025-10-09

